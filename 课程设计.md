# 课程设计

## 万年历嵌入式程序的设计和实现

### 实验任务

- 支持LCD屏幕上显示日期、时间、星期等信息（FSMC、LCD、RTC）；

- 支持开关按键/触摸按键等方式设置日期、时间（GPIO）；
- 支持触摸屏设置设置日期、时间（IIC、触控屏）；
- 支持向上位机实时报送当前日期、时间，支持上位机修改日期时间（USART）；
- 支持开机欢迎语（SPI/IIC、FLASH/EEPROM）；
- 支持设定闹钟，闹钟提醒为蜂鸣器（RTC、GPIO）。

### 实验思路

任务要求需要用到LCD、按键、蜂鸣器等，因此选用M5_LCD_KeyLED_Buzzer.ioc作为模板开始图形化配置。

基础知识部分，把高级抽象的部分作为分点，包括：

1. LCD
2. ...

### 基础知识

#### LCD驱动

#### HMI和LVGL图形库

### 实验步骤

#### LCD屏幕实现

##### FSMC接口初始化

![LCD_FSMC](.\asset\LCD_FSMC.png)

##### 移植LVGL

下载LVGL 8.4.0，将 lvgl 文件夹放到 Drivers/ 目录下，添加lvgl和example/porting的include。

![LVGL_includes](.\asset\LVGL_includes.png)

配置TIM9并启用中断

![TIM9](.\asset\TIM9.png)

**连接Tick接口**

在main的循环中调用`lv_timer_handler();`，在TIM9中断回调函数中调用`lv_tick_inc(1);`。

```c
int main(void)
{
  // ...
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
	lv_timer_handler();
  }
  /* USER CODE END 3 */
}

// ...

/* USER CODE BEGIN 4 */
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
  if(htim->Instance == TIM9)
  {
    lv_tick_inc(1);
  }
}
/* USER CODE END 4 */
```

**修改显示屏参数**

在tftlcd.h中修改为横屏显示：

```c
#define TFTLCD_DIR 1 // 0：竖屏  1：横屏  默认竖屏
```

修改 [lv_port_disp_template.c](project\Drivers\lvgl\examples\porting\lv_port_disp_template.c) ：

```c
/*Copy this file as "lv_port_disp.c" and set this value to "1" to enable content*/
#if 1					// <== Modified

/*********************
 *      INCLUDES
 *********************/
#include "lv_port_disp_template.h"
#include <stdbool.h>
#include "tftlcd.h"		// <== New

/*********************
 *      DEFINES
 *********************/
#ifndef MY_DISP_HOR_RES
    #warning Please define or replace the macro MY_DISP_HOR_RES with the actual screen width, default value 320 is used for now.
    #define MY_DISP_HOR_RES    800		// <== Modified
#endif

#ifndef MY_DISP_VER_RES
    #warning Please define or replace the macro MY_DISP_HOR_RES with the actual screen height, default value 240 is used for now.
    #define MY_DISP_VER_RES    480		// <== Modified
#endif
```

